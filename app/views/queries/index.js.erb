$(document).ready(function(){
    var stats = <%= raw @stats.to_json %>
    showHistoryTable();
    generateTable(stats.data);
    hashTerm(stats);
    appendTweetsSum();
    appendRetweetsSum();
    appendExposureSum();
    information();
});

function information() {
    var newParagraph = document.createElement("p");
    newParagraph.className = 'information';
    var textForParagraph = document.createTextNode('Results show total sums of uses for this hashtag in the past 30 days.');
    newParagraph.appendChild(textForParagraph);
    document.getElementById('summary').appendChild(newParagraph) 
}

function hashTerm(data) {
    var newParagraph = document.createElement("p");
    newParagraph.className = 'hash-term';
    var textForParagraph = document.createTextNode('#' + data['hashtag']);
    newParagraph.appendChild(textForParagraph);
    document.getElementById('summary').appendChild(newParagraph)
    data['hashtag'];
}

function appendExposureSum () {
    var newParagraph = document.createElement("p");
    newParagraph.className = 'hash-sum';
    var textForParagraph = document.createTextNode('Ex: ' + formatResults(exposureSum()));
    newParagraph.appendChild(textForParagraph);
    document.getElementById('summary').appendChild(newParagraph) 
}

function appendRetweetsSum() {
    var newParagraph = document.createElement("p");
    newParagraph.className = 'hash-sum';
    var textForParagraph = document.createTextNode('Rt: ' + formatResults(retweetsSum()));
    newParagraph.appendChild(textForParagraph);
    document.getElementById('summary').appendChild(newParagraph)  
}

function appendTweetsSum() {
    var newParagraph = document.createElement("p");
    newParagraph.className = 'hash-sum';
    var textForParagraph = document.createTextNode('Tw: ' + formatResults(tweetsSum()));
    newParagraph.appendChild(textForParagraph);
    document.getElementById('summary').appendChild(newParagraph)
}

function generateTable(data) {

    if ( ! $.fn.DataTable.isDataTable( '#tag-history-table' ) ) {
        $('#tag-history-table').DataTable({
        
        "searching": false,
        "data": data,
        "columns": [
            {
              "data": "date",
        	  render: function( value, type, row ) {
        	      return formatDate(value);
        	  }
          	},
          	{
          	  "data": "retweets",
          	   render: function( data, type, row ) {
          	      return formatResults( data );
          	  }
          	},
          	{
          	  "data": "tweets",
          	   render: function( data, type, row ) {
            	     return formatResults( data );
          	   }
          	},
          	{
                "data": "exposure",
                render: function( data, type, row ) {
                  return formatResults( data );
                }
          	}
          ]
        });
    }
}

function formatResults(value) {
    let result;
    
    if ( value == 0 || value == null || value == undefined || value == '') {
        return "N/A";
    }
   
    if ( value < 1000 && value > 0) {
	    return value;
    }
    
    if ( value > 1000 && value < 1000000 ) {
        result = value / 1000;
        return result.toFixed(1) + 'K';
    }
    
    if ( value > 1000000 && value < 1000000000 ) {
        result = value / 1000000;
        return result.toFixed(1) + "M";
    }
    
    if ( value > 100000000 && value < 100000000000 ) {
        result = value / 1000000000;
        return result.toFixed(1) + "B";
    }
    
    
    if ( value < 1000 && value > 0) {
        return value;
    }
    
}

function showHistoryTable() {
    $(".results-area").show();
    $('#summary').show();
}

function currentTime() {
    var time = new Date();
    return time.getHours() + ':' + time.getMinutes();
}

function tweetsSum() {
    var table = $('#tag-history-table').DataTable();
    return table.column( 1 ).data().sum();
}

function retweetsSum() {
    var table = $('#tag-history-table').DataTable();
    return table.column( 2 ).data().sum();
}

function exposureSum() {
    var table = $('#tag-history-table').DataTable();
    return table.column( 3 ).data().sum();
}

function formatDate(dateValue) {
    var months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug',
  		          'Sept', 'Oct', 'Nov', 'Dec'];
  		          
    var date2 = new Date(dateValue);
    return months[ date2.getMonth() ] + " " + date2.getDate() +
          ", " + date2.getFullYear();
}





